generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Sessions associated with current node. Only populated if the node is a
/// session maker.
model Session {
  environmentKey String
  session        String
  createdAt      DateTime

  @@id([environmentKey, session])
}

model PathInstance {
  environmentKey String
  /// E.g. 'nodeName:nodeSession/nodeName2/deviceName:deviceSession'. Always
  /// starts with the current node instance (name and possibly session), as it
  /// is prefixed to all incoming records.
  path           String
  /// Estimate of the real time associated with `ts=0` for a record from this
  /// path. Determined by backward-extropolating the time associated with `ts=0`
  /// upon encountering a record with a new path. Could be delayed by a few
  /// seconds.
  createdAt      DateTime

  records  Record[]
  messages Message[]

  @@id([environmentKey, path])
}

model Record {
  /// Order in which *this* node received the record. Used by this node to
  /// determine the order in which to sync records with the parent node.
  receivedAtIndex Int @id @default(autoincrement())

  pathInstance   PathInstance @relation(fields: [environmentKey, path], references: [environmentKey, path])
  environmentKey String
  /// Source path, e.g. 'nodeName:nodeSession/nodeName2/deviceName:deviceSession'.
  path           String
  /// Microseconds since start of device session.
  ts             BigInt
  data           Json
  sentToParent   Boolean      @default(false)

  @@unique([environmentKey, path, ts])
}

model Message {
  /// Order in which *this* node received the message. Used by devices as a
  /// pagination key for fetching new messages from this node.
  receivedAtIndex Int @id @default(autoincrement())

  pathInstance   PathInstance @relation(fields: [environmentKey, path], references: [environmentKey, path])
  environmentKey String
  /// Target path, e.g. 'nodeName:nodeSession/nodeName2/deviceName:deviceSession'.
  path           String
  data           Json
}
