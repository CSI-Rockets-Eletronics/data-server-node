generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model PathInstance {
  environmentKey String
  /// E.g. 'nodeName:nodeSession/nodeName2/deviceName:deviceSession'. Always
  /// starts with the current node instance (name and possibly session), as it
  /// is appended to all incoming records. If this node is a session maker, then
  /// standalone node instances 'nodeName:nodeSession' track when sessions on
  /// this node were created.
  path           String
  /// Estimate of the real time associated with `ts=0` for a record from this
  /// path. Determined by backward-extropolating the time associated with `ts=0`
  /// upon encountering a message with a new path. Could be delayed by a few
  /// seconds.
  createdAt      DateTime

  records  Record[]
  messages Message[]

  @@id([environmentKey, path])
}

model Record {
  pathInstance   PathInstance @relation(fields: [environmentKey, path], references: [environmentKey, path])
  environmentKey String
  /// Source path, e.g. 'nodeName:nodeSession/nodeName2/deviceName:deviceSession'.
  path           String
  /// Unix micros. Relative timestamp from the device.
  ts             BigInt
  data           Json
  sentToParent   Boolean

  @@id([environmentKey, path, ts])
}

model Message {
  pathInstance   PathInstance @relation(fields: [environmentKey, path], references: [environmentKey, path])
  environmentKey String
  /// Target path, e.g. 'nodeName:nodeSession/nodeName2/deviceName:deviceSession'.
  path           String
  /// When *this* node received the message. Used by devices as a
  /// pagination key for fetching new messages from this node.
  receivedAt     DateTime
  data           Json

  @@id([environmentKey, path, receivedAt])
}
